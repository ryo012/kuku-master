<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>‰πù‰πù„Éû„Çπ„Çø„Éº</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #4CAF50;
            --secondary-color: #2196F3;
            --accent-color: #FFC107;
            --error-color: #FF5252;
            --text-color: #333;
            --bg-color: #f0f4f8;
            --font-family: "Hiragino Kaku Gothic ProN", "Hiragino Sans", "Helvetica Neue", Arial, sans-serif;
        }

        * {
            box-sizing: border-box;
            touch-action: manipulation;
            /* „ÉÄ„Éñ„É´„Çø„ÉÉ„Éó„Ç∫„Éº„É†Èò≤Ê≠¢ */
            -webkit-user-select: none;
            /* „ÉÜ„Ç≠„Çπ„ÉàÈÅ∏ÊäûÈò≤Ê≠¢ */
            user-select: none;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            overflow: hidden;
        }

        h1,
        h2,
        h3 {
            margin: 0;
            text-align: center;
        }

        button {
            border: none;
            border-radius: 16px;
            font-family: inherit;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            box-shadow: 0 6px 0 #ccc;
            position: relative;
            top: 0;
        }

        button:active {
            transform: scale(0.92);
            box-shadow: 0 2px 0 #ccc;
            top: 4px;
        }

        /* ÁîªÈù¢„Ç≥„É≥„ÉÜ„Éä */
        .screen {
            display: none;
            /* JS„ÅßÂàá„ÇäÊõø„Åà */
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 800px;
            height: 100%;
            padding: 20px;
            animation: fadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .screen.active {
            display: flex;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.98);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* --- „Çπ„Çø„Éº„ÉàÁîªÈù¢ --- */
        .start-header {
            margin-bottom: 30px;
            text-align: center;
        }

        /* „Ç∞„É©„ÉïÁîªÈù¢„ÅÆ„Çπ„Çø„Ç§„É´ */
        .chart-container {
            width: 100%;
            height: 300px;
            margin: 20px 0;
            background: white;
            padding: 10px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .progress-detail {
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
            text-align: left;
        }

        .progress-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .progress-dan {
            font-weight: bold;
            font-size: 1.1em;
            color: #333;
        }

        .progress-status {
            font-size: 0.9em;
            color: #666;
        }

        .progress-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            color: white;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 8px;
        }

        .start-header h1 {
            font-size: 3rem;
            color: var(--primary-color);
            text-shadow: 3px 3px 0 rgba(0, 0, 0, 0.05);
            margin-bottom: 10px;
        }

        .dan-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            width: 100%;
            max-width: 500px;
            padding: 10px;
        }

        .dan-area {
            display: flex;
            gap: 15px;
            width: 100%;
            max-width: 620px;
            align-items: flex-start;
        }

        .level-legend {
            display: flex;
            flex-direction: column;
            gap: 4px;
            padding: 8px 6px;
            background: white;
            border-radius: 12px;
            border: 2px solid #e0e0e0;
            box-shadow: 0 4px 0 #e0e0e0;
            flex-shrink: 0;
            width: 52px;
            align-items: center;
        }

        .level-legend-title {
            font-size: 0.6rem;
            font-weight: bold;
            color: #999;
            margin-bottom: 2px;
        }

        .level-dot {
            width: 36px;
            height: 18px;
            border-radius: 4px;
        }

        .dan-btn {
            background-color: white;
            color: var(--secondary-color);
            font-size: 2.2rem;
            padding: 0;
            border: 3px solid #e0e0e0;
            box-shadow: 0 6px 0 #e0e0e0;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .dan-btn:active {
            box-shadow: 0 2px 0 #e0e0e0;
        }

        .dan-label {
            padding: 15px 0 5px;
            font-size: 2.2rem;
            font-weight: bold;
            pointer-events: none;
        }

        .mastery-bar {
            display: flex;
            width: 100%;
            height: 18px;
            pointer-events: none;
        }

        .mastery-half {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.55rem;
            font-weight: bold;
            color: rgba(0, 0, 0, 0.4);
            transition: background-color 0.5s;
        }

        .mastery-half.left {
            border-right: 1px solid rgba(0, 0, 0, 0.1);
        }

        /* ÁøíÁÜüÂ∫¶„Ç´„É©„Éº */
        .mastery-none {
            background-color: #e0e0e0;
        }

        .mastery-started {
            background-color: #ef5350;
            color: white !important;
        }

        .mastery-review {
            background-color: #ffa726;
        }

        .mastery-growing {
            background-color: #ffee58;
        }

        .mastery-almost {
            background-color: #9ccc65;
        }

        .mastery-complete {
            background-color: #42a5f5;
            color: white !important;
        }

        .dan-btn.zenbu {
            grid-column: span 3;
            background: linear-gradient(135deg, var(--secondary-color), #4dabf7);
            color: white;
            border: none;
            box-shadow: 0 6px 0 #1971c2;
        }

        .dan-btn.zenbu:active {
            box-shadow: 0 2px 0 #1971c2;
        }

        /* „Åä„Åô„Åô„ÇÅ„Éú„Çø„É≥ */
        .recommend-btn {
            width: 100%;
            background: linear-gradient(135deg, var(--accent-color), #ffd54f);
            color: #5d4037;
            font-size: 1.3rem;
            padding: 20px;
            border: none;
            box-shadow: 0 6px 0 #f59f00;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.2s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .recommend-btn:active {
            box-shadow: 0 2px 0 #f59f00;
            top: 4px;
        }

        /* „Çè„Åã„Çâ„Å™„ÅÑ„Éú„Çø„É≥ */
        .skip-btn {
            background: transparent;
            color: #999;
            font-size: 1.1rem;
            font-weight: bold;
            border: 2px dashed #ccc;
            border-radius: 30px;
            padding: 10px 40px;
            margin-top: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .skip-btn:active {
            background: #f0f0f0;
            color: #666;
        }

        /* --- „É¢„Éº„ÉâÈÅ∏Êäû„ÉÄ„Ç§„Ç¢„É≠„Ç∞ --- */
        .dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
        }

        .dialog-overlay.active {
            display: flex;
        }

        .dialog-content {
            background: white;
            padding: 30px;
            border-radius: 24px;
            text-align: center;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            width: 90%;
            max-width: 420px;
            animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from {
                transform: scale(0.5);
                opacity: 0;
            }

            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .mode-btn {
            display: block;
            width: 100%;
            padding: 18px;
            margin: 15px 0;
            font-size: 1.6rem;
            color: white;
            border-radius: 16px;
        }

        .mode-btn.junban {
            background-color: var(--primary-color);
            box-shadow: 0 6px 0 #2f7a33;
        }

        .mode-btn.junban:active {
            box-shadow: 0 2px 0 #2f7a33;
        }

        .mode-btn.barabara {
            background-color: var(--accent-color);
            color: #5d4037;
            box-shadow: 0 6px 0 #f59f00;
        }

        .mode-btn.barabara:active {
            box-shadow: 0 2px 0 #f59f00;
        }

        .mode-btn.cancel {
            background-color: #eee;
            color: #777;
            margin-top: 20px;
            font-size: 1.2rem;
            box-shadow: 0 4px 0 #ccc;
        }

        .mode-btn.cancel:active {
            box-shadow: 0 2px 0 #ccc;
        }

        /* --- Â≠¶ÁøíÁîªÈù¢ --- */
        .game-header {
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 5px 15px;
            margin-bottom: 5px;
        }

        .combo-badge {
            background: var(--accent-color);
            color: #5d4037;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.2rem;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s;
        }

        .combo-badge.active {
            opacity: 1;
            transform: translateY(0);
        }

        .home-btn-mini {
            background: #fff;
            color: #555;
            padding: 12px 24px;
            /* „Çµ„Ç§„Ç∫Êã°Â§ß */
            font-size: 1.1rem;
            font-weight: bold;
            border: 2px solid #ddd;
            border-radius: 30px;
            /* ‰∏∏„Åø„ÇíÂ¢ó„ÇÑ„Åô */
            box-shadow: 0 4px 0 #eee;
            min-width: 100px;
            /* Êäº„Åó„ÇÑ„Åô„ÅÑÂπÖ */
        }

        .home-btn-mini:active {
            box-shadow: 0 2px 0 #eee;
        }

        .question-area {
            flex: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px 0;
            font-size: 5rem;
            font-weight: bold;
            color: var(--text-color);
            width: 100%;
            position: relative;
        }

        .answer-box {
            display: inline-block;
            min-width: 1.5em;
            border-bottom: 4px solid var(--text-color);
            text-align: center;
            color: var(--primary-color);
            margin-left: 10px;
        }

        /* Ê≠£Ëß£„Éª‰∏çÊ≠£Ëß£„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥Ë°®Á§∫ */
        .feedback {
            position: absolute;
            font-size: 8rem;
            /* Â∞ë„ÅóÁ∏ÆÂ∞è */
            opacity: 0;
            pointer-events: none;
            z-index: 10;
        }

        .feedback.correct {
            color: var(--primary-color);
        }

        .feedback.wrong {
            color: var(--error-color);
        }

        @keyframes feedbackAnim {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }

            50% {
                transform: scale(1.2);
                opacity: 1;
            }

            100% {
                transform: scale(1);
                opacity: 0;
            }
        }

        .numpad-container {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            width: 100%;
            max-width: 600px;
            margin-bottom: 30px;
        }

        .home-btn-side {
            background: linear-gradient(135deg, #fff, #f5f5f5);
            color: #555;
            padding: 20px 15px;
            font-size: 1rem;
            font-weight: bold;
            border: 3px solid #ddd;
            border-radius: 16px;
            box-shadow: 0 6px 0 #ccc;
            writing-mode: vertical-rl;
            text-orientation: upright;
            letter-spacing: 2px;
            min-height: 180px;
            cursor: pointer;
        }

        .home-btn-side:active {
            box-shadow: 0 2px 0 #ccc;
            top: 4px;
        }

        .numpad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            width: 100%;
            max-width: 400px;
        }

        .num-btn {
            background-color: white;
            font-size: 2rem;
            color: #333;
            border-bottom: 4px solid #ddd;
            border-radius: 12px;
            padding: 20px 0;
        }

        .num-btn:active {
            border-bottom: none;
            transform: translateY(4px);
        }

        .num-btn.clear {
            background-color: #FFEBEE;
            color: var(--error-color);
        }

        .num-btn.ok {
            background-color: #E8F5E9;
            color: var(--primary-color);
        }

        /* ÈÄ≤Êçó„Éê„Éº */
        .progress-bar {
            width: 100%;
            height: 10px;
            background-color: #e0e0e0;
            border-radius: 5px;
            margin-bottom: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background-color: var(--primary-color);
            width: 0%;
            transition: width 0.3s;
        }


        /* --- ÁµêÊûúÁîªÈù¢ --- */
        .result-content {
            text-align: center;
            width: 100%;
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .stamp {
            width: 120px;
            height: 120px;
            border: 5px solid var(--error-color);
            color: var(--error-color);
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 2rem;
            font-weight: bold;
            transform: rotate(-15deg);
            margin: 10px auto;
            opacity: 0;
            animation: stampAnim 0.5s ease-out 0.5s forwards;
            flex-shrink: 0;
        }

        @keyframes stampAnim {
            from {
                transform: scale(2) rotate(-15deg);
                opacity: 0;
            }

            to {
                transform: scale(1) rotate(-15deg);
                opacity: 0.8;
            }
        }

        .score-list {
            list-style: none;
            padding: 0;
            margin: 10px 0;
            text-align: left;
            flex: 1;
            /* ÊÆã„Çä„ÅÆ„Çπ„Éö„Éº„Çπ„Çí‰Ωø„ÅÜ */
            overflow-y: auto;
            background: white;
            border-radius: 10px;
            padding: 10px;
            border: 1px solid #eee;
        }

        .score-list li {
            padding: 8px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            font-size: 1.2rem;
        }

        .action-btns {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 10px;
            margin-bottom: 20px;
            flex-shrink: 0;
        }

        .action-btn {
            padding: 15px 30px;
            font-size: 1.2rem;
            background-color: var(--primary-color);
            color: white;
            min-width: 150px;
        }

        .action-btn.secondary {
            background-color: white;
            color: var(--text-color);
            border: 2px solid #ddd;
        }

        .chart-section {
            width: 100%;
            background: white;
            margin-top: 10px;
            border-radius: 10px;
            padding: 10px;
            flex-shrink: 0;
        }

        .chart-container {
            width: 100%;
            height: 100px;
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
        }

        .bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 10%;
            height: 100%;
            justify-content: flex-end;
        }

        /* „É¨„Éô„É´Ë™¨Êòé„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó */
        .level-desc-row {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            text-align: left;
            border-bottom: 1px dashed #eee;
            padding-bottom: 10px;
        }

        .level-desc-row:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .level-desc-dot {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            margin-right: 15px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .level-desc-content {
            flex: 1;
        }

        .level-desc-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 4px;
            color: var(--primary-color);
        }

        .level-desc-text {
            font-size: 0.9rem;
            color: #666;
            line-height: 1.4;
        }

        .help-btn {
            background: #eee;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            margin-left: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .bar-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 10%;
            height: 100%;
            justify-content: flex-end;
        }

        .bar {
            width: 100%;
            background-color: var(--secondary-color);
            border-radius: 4px 4px 0 0;
            transition: height 0.5s;
            min-height: 2px;
        }

        .bar-label {
            font-size: 0.8rem;
            margin-top: 5px;
        }
    </style>
</head>

<body>

    <!-- 1. „Çπ„Çø„Éº„ÉàÁîªÈù¢ -->
    <div id="screen-start" class="screen active">
        <div class="start-header">
            <h1>‰πù‰πù„Éû„Çπ„Çø„Éº</h1>
            <p id="session-subtitle">„Å†„Çì „Çí „Åà„Çâ„Çì„Åß„Å≠</p>
            <button class="mode-btn" style="background: #9C27B0; margin-top: 10px; font-size: 1rem; padding: 10px 20px;"
                onclick="showProgressScreen()">üìä „Åò„Å§„Çä„Çá„Åè„Ç∞„É©„Éï</button>
        </div>

        <!-- „Åä„Åô„Åô„ÇÅ„Éú„Çø„É≥ -->
        <div id="recommend-section" style="width: 100%; max-width: 500px; margin-bottom: 20px; display: none;">
            <button id="recommend-btn" class="recommend-btn" onclick="startReviewMode()">
                <div style="font-size: 1.2rem; font-weight: bold;">„Äê„Åä„Åô„Åô„ÇÅ„Äë</div>
                <div id="recommend-text" style="font-size: 1.5rem; margin: 5px 0;"></div>
                <div id="recommend-count" style="font-size: 1rem; opacity: 0.8;"></div>
            </button>
        </div>

        <div class="dan-area">
            <div class="level-legend">
                <div style="display:flex; width:100%; align-items:center; margin-bottom:5px;">
                    <div class="level-legend-title" style="margin:0;">„É¨„Éô„É´</div>
                    <button class="help-btn" onclick="openLevelDialog()">?</button>
                </div>

                <div class="level-dot mastery-complete" title="„Åã„Çì„Å∫„Åç"></div>
                <div class="level-dot mastery-almost" title="„ÇÇ„ÅÜ„Åô„Åê"></div>
                <div class="level-dot mastery-growing" title="„ÅÑ„ÅÑ„Åã„Çì„Åò"></div>
                <div class="level-dot mastery-review" title="„Åä„Åº„Åà„ÅØ„Åò„ÇÅ"></div>
                <div class="level-dot mastery-started" title="„Çå„Çì„Åó„ÇÖ„ÅÜ"></div>
                <div class="level-dot mastery-none" title="„Åæ„Å†"></div>
            </div>
            <div class="dan-grid">
                <!-- 3„Äú9„ÅÆÊÆµ -->
                <button class="dan-btn" id="dan-3" onclick="openModeDialog(3)">
                    <span class="dan-label">3</span>
                    <div class="mastery-bar"><span class="mastery-half left mastery-none" id="m-3-j">„ÅÆ</span><span
                            class="mastery-half mastery-none" id="m-3-b">„Éê</span></div>
                </button>
                <button class="dan-btn" id="dan-4" onclick="openModeDialog(4)">
                    <span class="dan-label">4</span>
                    <div class="mastery-bar"><span class="mastery-half left mastery-none" id="m-4-j">„ÅÆ</span><span
                            class="mastery-half mastery-none" id="m-4-b">„Éê</span></div>
                </button>
                <button class="dan-btn" id="dan-5" onclick="openModeDialog(5)">
                    <span class="dan-label">5</span>
                    <div class="mastery-bar"><span class="mastery-half left mastery-none" id="m-5-j">„ÅÆ</span><span
                            class="mastery-half mastery-none" id="m-5-b">„Éê</span></div>
                </button>
                <button class="dan-btn" id="dan-6" onclick="openModeDialog(6)">
                    <span class="dan-label">6</span>
                    <div class="mastery-bar"><span class="mastery-half left mastery-none" id="m-6-j">„ÅÆ</span><span
                            class="mastery-half mastery-none" id="m-6-b">„Éê</span></div>
                </button>
                <button class="dan-btn" id="dan-7" onclick="openModeDialog(7)">
                    <span class="dan-label">7</span>
                    <div class="mastery-bar"><span class="mastery-half left mastery-none" id="m-7-j">„ÅÆ</span><span
                            class="mastery-half mastery-none" id="m-7-b">„Éê</span></div>
                </button>
                <button class="dan-btn" id="dan-8" onclick="openModeDialog(8)">
                    <span class="dan-label">8</span>
                    <div class="mastery-bar"><span class="mastery-half left mastery-none" id="m-8-j">„ÅÆ</span><span
                            class="mastery-half mastery-none" id="m-8-b">„Éê</span></div>
                </button>
                <button class="dan-btn" id="dan-9" onclick="openModeDialog(9)">
                    <span class="dan-label">9</span>
                    <div class="mastery-bar"><span class="mastery-half left mastery-none" id="m-9-j">„ÅÆ</span><span
                            class="mastery-half mastery-none" id="m-9-b">„Éê</span></div>
                </button>

                <button class="dan-btn zenbu" onclick="openModeDialog('all')">„Åú„Çì„Å∂ (3„Äú9)</button>
            </div>
        </div>
    </div>

    <!-- „É¢„Éº„ÉâÈÅ∏Êäû„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div id="mode-dialog" class="dialog-overlay">
        <div class="dialog-content">
            <h2 id="dialog-title">‚óØ„ÅÆ„Å†„Çì</h2>
            <p>„Åò„ÇÖ„Çì„Å∞„Çì „Çí „Åà„Çâ„Çì„Åß„Å≠</p>
            <button class="mode-btn junban" onclick="startGame('junban')">„Åò„ÇÖ„Çì„Å∞„Çì („ÅÆ„Åº„Çä)</button>
            <button class="mode-btn barabara" onclick="startGame('barabara')">„Éê„É©„Éê„É©</button>
            <button class="mode-btn cancel" onclick="closeModeDialog()">„ÇÑ„ÇÅ„Çã</button>
        </div>
    </div>

    <!-- „É¨„Éô„É´Ë™¨Êòé„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div id="level-dialog" class="dialog-overlay">
        <div class="dialog-content" style="max-width: 500px;">
            <h2>„É¨„Éô„É´„ÅÆ „Å≤„Åø„Å§</h2>
            <div style="max-height: 400px; overflow-y: auto; padding: 10px;">

                <div class="level-desc-row">
                    <div class="level-desc-dot mastery-complete">‚ú®</div>
                    <div class="level-desc-content">
                        <div class="level-desc-title">‰πù‰πù„Éû„Çπ„Çø„ÉºÔºÅ („Åã„Çì„Å∫„Åç)</div>
                        <div class="level-desc-text">„Åô„Åî„ÅÑÔºÅ „Åô„Åπ„Å¶„ÅÆ„Åµ„Åè„Åó„ÇÖ„ÅÜ„Çí „ÇØ„É™„Ç¢„Åó„Åü„ÇàÔºÅ<br>„ÇÇ„ÅÜ „Åç„Åø„ÅØ „ÇÄ„Å¶„Åç„Å†ÔºÅ</div>
                    </div>
                </div>

                <div class="level-desc-row">
                    <div class="level-desc-dot mastery-almost"></div>
                    <div class="level-desc-content">
                        <div class="level-desc-title">„ÇÇ„ÅÜ„Åô„Åê „Åã„Çì„Å∫„Åç</div>
                        <div class="level-desc-text">1„Åó„ÇÖ„ÅÜ„Åã„Çì„Åî„ÅÆ „Åµ„Åè„Åó„ÇÖ„ÅÜ„ÇÇ „Åõ„ÅÑ„Åã„ÅÑ„Åß„Åç„ÅüÔºÅ<br>„ÅÇ„Å®„Åô„Åì„Åó„Åß „Éû„Çπ„Çø„Éº„Å†ÔºÅ</div>
                    </div>
                </div>

                <div class="level-desc-row">
                    <div class="level-desc-dot mastery-growing"></div>
                    <div class="level-desc-content">
                        <div class="level-desc-title">„Åó„Å£„Åã„Çä „Åä„Åº„Åà„Å¶„Åç„Åü</div>
                        <div class="level-desc-text">3„Åã„Åî„ÅÆ „Åµ„Åè„Åó„ÇÖ„ÅÜ„ÇÇ „Åõ„ÅÑ„Åã„ÅÑ„Åß„Åç„ÅüÔºÅ<br>„Çè„Åô„Çå„Å´„Åè„Åè „Å™„Å£„Å¶„Åç„Åü„Çà„ÄÇ</div>
                    </div>
                </div>

                <div class="level-desc-row">
                    <div class="level-desc-dot mastery-review"></div>
                    <div class="level-desc-content">
                        <div class="level-desc-title">„Åä„Åº„Åà„ÅØ„Åò„ÇÅ</div>
                        <div class="level-desc-text">„Åç„ÅÆ„ÅÜ„ÅÆ „Åµ„Åè„Åó„ÇÖ„ÅÜ„ÅØ „Åõ„ÅÑ„Åã„ÅÑ„Åß„Åç„Åü„Å≠„ÄÇ<br>„Åæ„Å† „Çè„Åô„Çå„ÇÑ„Åô„ÅÑ„Åã„Çâ „Åç„Çí„Å§„Åë„Çà„ÅÜ„ÄÇ</div>
                    </div>
                </div>

                <div class="level-desc-row">
                    <div class="level-desc-dot mastery-started"></div>
                    <div class="level-desc-content">
                        <div class="level-desc-title">„Çå„Çì„Åó„ÇÖ„ÅÜ‰∏≠</div>
                        <div class="level-desc-text">„Åæ„Å°„Åå„ÅÑ„Åå „Åä„Åä„ÅÑ„Çà„ÄÇ<br>„Å™„Çì„Å©„ÇÇ „Çå„Çì„Åó„ÇÖ„ÅÜ„Åó„Å¶ „Åä„Åº„Åà„Çà„ÅÜÔºÅ</div>
                    </div>
                </div>

                <div class="level-desc-row">
                    <div class="level-desc-dot mastery-none"></div>
                    <div class="level-desc-content">
                        <div class="level-desc-title">„Åæ„Å† „ÇÑ„Å£„Å¶„ÅÑ„Å™„ÅÑ</div>
                        <div class="level-desc-text">„Åæ„Åö„ÅØ 1„Åã„ÅÑ „ÉÅ„É£„É¨„É≥„Ç∏„Åó„Å¶„Åø„Çà„ÅÜÔºÅ</div>
                    </div>
                </div>

            </div>
            <button class="mode-btn" onclick="closeLevelDialog()">„Çè„Åã„Å£„ÅüÔºÅ</button>
        </div>
    </div>

    <!-- „Ç∞„É©„ÉïÁîªÈù¢ -->
    <div id="screen-progress" class="screen">
        <h1>„ÅÇ„Å™„Åü„ÅÆ„Åò„Å§„Çä„Çá„Åè</h1>
        <div class="chart-container">
            <canvas id="masteryChart"></canvas>
        </div>

        <div class="progress-detail" id="progress-list">
            <!-- JS„ÅßÁîüÊàê -->
        </div>

        <button class="mode-btn" onclick="showScreen('screen-start')"
            style="margin-top: 20px; background:#FF5252;">„ÇÇ„Å©„Çã</button>
    </div>

    <!-- 2. Â≠¶ÁøíÁîªÈù¢ -->
    <div id="screen-game" class="screen">
        <div class="game-header">
            <div id="combo-badge" class="combo-badge">0 „Ç≥„É≥„ÉúÔºÅ</div>
        </div>

        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>

        <div class="question-area">
            <span id="q-left"></span> √ó <span id="q-right"></span> = <span id="answer-box" class="answer-box"></span>
            <div id="feedback" class="feedback">‚óã</div>
        </div>

        <div class="numpad-container">
            <button class="home-btn-side" onclick="confirmHome()">HOME</button>
            <div class="numpad">
                <button class="num-btn" onclick="inputNum(1)">1</button>
                <button class="num-btn" onclick="inputNum(2)">2</button>
                <button class="num-btn" onclick="inputNum(3)">3</button>
                <button class="num-btn" onclick="inputNum(4)">4</button>
                <button class="num-btn" onclick="inputNum(5)">5</button>
                <button class="num-btn" onclick="inputNum(6)">6</button>
                <button class="num-btn" onclick="inputNum(7)">7</button>
                <button class="num-btn" onclick="inputNum(8)">8</button>
                <button class="num-btn" onclick="inputNum(9)">9</button>
                <button class="num-btn clear" onclick="clearInput()">C</button>
                <button class="num-btn zero" onclick="inputNum(0)">0</button>
                <button class="num-btn ok" onclick="checkAnswer()">OK</button>
            </div>
        </div>
        <button class="skip-btn" onclick="skipQuestion()">„Çè„Åã„Çâ„Å™„ÅÑ</button>
    </div>

    <!-- 3. ÁµêÊûúÁîªÈù¢ -->
    <div id="screen-result" class="screen">
        <div class="result-content">
            <h2>„Åä„Å§„Åã„Çå„Åï„ÅæÔºÅ</h2>
            <div id="stamp" class="stamp">ÂêàÊ†º</div>

            <p style="font-size: 1.2rem;">„Åõ„ÅÑ„Åã„ÅÑ: <span id="score-text"
                    style="font-weight:bold; font-size:1.5rem;"></span></p>

            <div style="width:100%; text-align:left; font-weight:bold; margin-top:10px;">„Åæ„Å°„Åå„Åà„Åü „ÇÇ„Çì„Å†„ÅÑ</div>
            <ul id="wrong-list" class="score-list">
                <!-- JS„ÅßÊåøÂÖ• -->
            </ul>

            <div class="chart-section">
                <div style="font-size:0.9rem; margin-bottom:5px;">„Å´„Åå„Å¶„Å™ „Å†„Çì („Åõ„ÅÑ„Åã„ÅÑÁéá)</div>
                <div id="chart-container" class="chart-container">
                    <!-- JS„Åß„Ç∞„É©„ÉïÊèèÁîª -->
                </div>
            </div>


            <div class="action-btns">
                <button class="action-btn" onclick="location.reload()">„ÇÇ„ÅÜ„ÅÑ„Å°„Å©</button>
                <button class="action-btn" style="background: linear-gradient(135deg, #4caf50, #66bb6a);"
                    onclick="openNumberDialog()">„Åõ„Çì„Åõ„ÅÑ„Å´„Åä„Åè„Çã</button>
            </div>

            <!-- Âá∫Â∏≠Áï™Âè∑ÂÖ•Âäõ„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
            <div id="number-dialog" class="dialog-overlay">
                <div class="dialog-content">
                    <h2>„Åó„ÇÖ„Å£„Åõ„Åç„Å∞„Çì„Åî„ÅÜ</h2>
                    <p>„Å∞„Çì„Åî„ÅÜ„Çí„ÅÑ„Çå„Å¶„Å≠</p>
                    <div id="number-display"
                        style="font-size: 3rem; font-weight: bold; min-height: 60px; color: var(--primary-color); margin: 10px 0;">
                    </div>
                    <div class="numpad" style="height: auto; max-width: 300px; margin: 0 auto;">
                        <button class="num-btn" onclick="inputStudentNum(1)">1</button>
                        <button class="num-btn" onclick="inputStudentNum(2)">2</button>
                        <button class="num-btn" onclick="inputStudentNum(3)">3</button>
                        <button class="num-btn" onclick="inputStudentNum(4)">4</button>
                        <button class="num-btn" onclick="inputStudentNum(5)">5</button>
                        <button class="num-btn" onclick="inputStudentNum(6)">6</button>
                        <button class="num-btn" onclick="inputStudentNum(7)">7</button>
                        <button class="num-btn" onclick="inputStudentNum(8)">8</button>
                        <button class="num-btn" onclick="inputStudentNum(9)">9</button>
                        <button class="num-btn clear" onclick="clearStudentNum()">C</button>
                        <button class="num-btn zero" onclick="inputStudentNum(0)">0</button>
                        <button class="num-btn ok" onclick="submitStudentNum()">OK</button>
                    </div>
                    <button class="mode-btn cancel" onclick="closeNumberDialog()" style="margin-top: 10px;">„ÇÑ„ÇÅ„Çã</button>
                </div>
            </div>
        </div>
    </div>



    <!-- „É¨„Éô„É´Ë™¨Êòé„ÉÄ„Ç§„Ç¢„É≠„Ç∞ -->
    <div id="level-dialog" class="dialog-overlay">
        <div class="dialog-content" style="max-width: 500px;">
            <h2>„É¨„Éô„É´„ÅÆ „Å≤„Åø„Å§</h2>
            <div style="max-height: 400px; overflow-y: auto; padding: 10px;">

                <div class="level-desc-row">
                    <div class="level-desc-dot mastery-complete">‚ú®</div>
                    <div class="level-desc-content">
                        <div class="level-desc-title">‰πù‰πù„Éû„Çπ„Çø„ÉºÔºÅ („Åã„Çì„Å∫„Åç)</div>
                        <div class="level-desc-text">„Åô„Åî„ÅÑÔºÅ „Åô„Åπ„Å¶„ÅÆ„Åµ„Åè„Åó„ÇÖ„ÅÜ„Çí „ÇØ„É™„Ç¢„Åó„Åü„ÇàÔºÅ<br>„ÇÇ„ÅÜ „Åç„Åø„ÅØ „ÇÄ„Å¶„Åç„Å†ÔºÅ</div>
                    </div>
                </div>

                <div class="level-desc-row">
                    <div class="level-desc-dot mastery-almost"></div>
                    <div class="level-desc-content">
                        <div class="level-desc-title">„ÇÇ„ÅÜ„Åô„Åê „Åã„Çì„Å∫„Åç</div>
                        <div class="level-desc-text">1„Åó„ÇÖ„ÅÜ„Åã„Çì„Åî„ÅÆ „Åµ„Åè„Åó„ÇÖ„ÅÜ„ÇÇ „Åõ„ÅÑ„Åã„ÅÑ„Åß„Åç„ÅüÔºÅ<br>„ÅÇ„Å®„Åô„Åì„Åó„Åß „Éû„Çπ„Çø„Éº„Å†ÔºÅ</div>
                    </div>
                </div>

                <div class="level-desc-row">
                    <div class="level-desc-dot mastery-growing"></div>
                    <div class="level-desc-content">
                        <div class="level-desc-title">„Åó„Å£„Åã„Çä „Åä„Åº„Åà„Å¶„Åç„Åü</div>
                        <div class="level-desc-text">3„Åã„Åî„ÅÆ „Åµ„Åè„Åó„ÇÖ„ÅÜ„ÇÇ „Åõ„ÅÑ„Åã„ÅÑ„Åß„Åç„ÅüÔºÅ<br>„Çè„Åô„Çå„Å´„Åè„Åè „Å™„Å£„Å¶„Åç„Åü„Çà„ÄÇ</div>
                    </div>
                </div>

                <div class="level-desc-row">
                    <div class="level-desc-dot mastery-review"></div>
                    <div class="level-desc-content">
                        <div class="level-desc-title">„Åä„Åº„Åà„ÅØ„Åò„ÇÅ</div>
                        <div class="level-desc-text">„Åç„ÅÆ„ÅÜ„ÅÆ „Åµ„Åè„Åó„ÇÖ„ÅÜ„ÅØ „Åõ„ÅÑ„Åã„ÅÑ„Åß„Åç„Åü„Å≠„ÄÇ<br>„Åæ„Å† „Çè„Åô„Çå„ÇÑ„Åô„ÅÑ„Åã„Çâ „Åç„Çí„Å§„Åë„Çà„ÅÜ„ÄÇ</div>
                    </div>
                </div>

                <div class="level-desc-row">
                    <div class="level-desc-dot mastery-started"></div>
                    <div class="level-desc-content">
                        <div class="level-desc-title">„Çå„Çì„Åó„ÇÖ„ÅÜ‰∏≠</div>
                        <div class="level-desc-text">„Åæ„Å°„Åå„ÅÑ„Åå „Åä„Åä„ÅÑ„Çà„ÄÇ<br>„Å™„Çì„Å©„ÇÇ „Çå„Çì„Åó„ÇÖ„ÅÜ„Åó„Å¶ „Åä„Åº„Åà„Çà„ÅÜÔºÅ</div>
                    </div>
                </div>

                <div class="level-desc-row">
                    <div class="level-desc-dot mastery-none"></div>
                    <div class="level-desc-content">
                        <div class="level-desc-title">„Åæ„Å† „ÇÑ„Å£„Å¶„ÅÑ„Å™„ÅÑ</div>
                        <div class="level-desc-text">„Åæ„Åö„ÅØ 1„Åã„ÅÑ „ÉÅ„É£„É¨„É≥„Ç∏„Åó„Å¶„Åø„Çà„ÅÜÔºÅ</div>
                    </div>
                </div>

            </div>
            <button class="mode-btn" onclick="closeLevelDialog()">„Çè„Åã„Å£„ÅüÔºÅ</button>
        </div>
    </div>

    <script>
        /**
         * „Éá„Éº„ÇøÊßãÈÄ†
         * HistoryItem: { q: "3x4", correct: bool, time: number, date: timestamp }
         */

        // „Ç∞„É≠„Éº„Éê„É´Â§âÊï∞
        let currentDan = 0; // 'all' or 3-9
        let currentMode = ''; // 'junban' or 'barabara'
        let questionList = [];
        let currentIndex = 0;
        let currentInput = "";
        let results = []; // ‰ªäÂõû„ÅÆÁµêÊûú {q: [3,4], input: 12, correct: true}
        let startTime = 0;
        let wrongCountForCurrentQuestion = 0; // ÁèæÂú®„ÅÆÂïèÈ°å„Åß„ÅÆË™§Á≠îÂõûÊï∞
        let comboCount = 0;
        let isProcessing = false; // ÈÄ£ÊâìÈò≤Ê≠¢Áî®„Éï„É©„Ç∞

        // LocalStorage„Ç≠„Éº
        const STORAGE_KEY = 'kuku_master_data_v1';
        const REVIEW_STORAGE_KEY = 'kuku_master_review_v1';

        // ÊôÇÈñìÂ∏ØÂà§ÂÆö
        function getCurrentSession() {
            // „ÉÜ„Çπ„Éà„É¢„Éº„Éâ: URL„Éë„É©„É°„Éº„Çø„ÅßÊôÇÈñìÂ∏Ø„ÇíÊåáÂÆöÂèØËÉΩ
            const urlParams = new URLSearchParams(window.location.search);
            const testMode = urlParams.get('test');
            if (testMode) {
                if (['morning', 'noon', 'evening', 'free'].includes(testMode)) {
                    return testMode;
                }
            }

            const now = new Date();
            const hour = now.getHours();
            const minute = now.getMinutes();

            if (hour === 8) return 'morning';
            if (hour >= 9 && (hour < 12 || (hour === 12 && minute <= 30))) return 'noon';
            if ((hour === 12 && minute >= 45) || (hour >= 13 && hour < 18)) return 'evening';
            return 'free';
        }

        // „Çª„ÉÉ„Ç∑„Éß„É≥Âêç„ÅÆÊó•Êú¨Ë™ûË°®Á§∫
        function getSessionName(session) {
            const names = {
                'morning': '„ÅÇ„Åï„ÅÆ„Çå„Çì„Åó„ÇÖ„ÅÜ',
                'noon': '„Å≤„Çã„ÅÆ„Çå„Çì„Åó„ÇÖ„ÅÜ',
                'evening': '„Åã„Åà„Çä„ÅÆ„Çå„Çì„Åó„ÇÖ„ÅÜ',
                'free': '„Åò„ÇÜ„ÅÜ„Çå„Çì„Åó„ÇÖ„ÅÜ'
            };
            return names[session] || '„Çå„Çì„Åó„ÇÖ„ÅÜ';
        }

        // --- ÂàùÊúüÂåñ„Éª„Éá„Éº„Çø„É≠„Éº„Éâ ---
        function loadData() {
            try {
                const data = localStorage.getItem(STORAGE_KEY);
                return data ? JSON.parse(data) : { history: [] };
            } catch (e) {
                return { history: [] };
            }
        }

        function saveData(newHistoryItem) {
            const data = loadData();
            data.history.push(newHistoryItem);
            // ÊúÄÊñ∞1000‰ª∂„ÅÆ„Åø‰øùÂ≠òÔºàÂÆπÈáèÁØÄÁ¥ÑÔºâ
            if (data.history.length > 1000) data.history.shift();
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // --- Âæ©Áøí„Éá„Éº„ÇøÁÆ°ÁêÜ ---
        function loadReviewData() {
            try {
                const data = localStorage.getItem(REVIEW_STORAGE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) {
                return [];
            }
        }

        function saveReviewData(reviewData) {
            localStorage.setItem(REVIEW_STORAGE_KEY, JSON.stringify(reviewData));
        }

        // --- ÈÄÅ‰ø°„Ç≠„É•„Éº„ÉªÁîüÂæíÁï™Âè∑ÁÆ°ÁêÜ ---
        const QUEUE_KEY = 'kuku_master_send_queue_v1';
        const STUDENT_NUM_KEY = 'kuku_master_student_num_v1';

        function loadQueue() {
            try {
                const data = localStorage.getItem(QUEUE_KEY);
                return data ? JSON.parse(data) : [];
            } catch (e) { return []; }
        }

        function saveQueue(queue) {
            localStorage.setItem(QUEUE_KEY, JSON.stringify(queue));
        }

        function addToQueue(data) {
            const queue = loadQueue();
            queue.push(data);
            saveQueue(queue);
            processQueue(); // ËøΩÂä†„Åó„Åü„ÇâÂç≥Â∫ß„Å´ÈÄÅ‰ø°Ë©¶Ë°å
        }

        function loadStudentNum() {
            return localStorage.getItem(STUDENT_NUM_KEY) || '';
        }

        function saveStudentNum(num) {
            localStorage.setItem(STUDENT_NUM_KEY, num);
        }

        // Âæ©Áøí„Çπ„Ç±„Ç∏„É•„Éº„É´„ÅÆË®àÁÆó
        function calculateNextReview(question, isCorrect) {
            const reviewData = loadReviewData();
            const now = new Date();
            const today = now.toISOString().split('T')[0];

            let item = reviewData.find(r => r.question === question);

            if (!item) {
                // Êñ∞Ë¶èÁôªÈå≤
                item = {
                    question: question,
                    lastReviewed: now.toISOString(),
                    nextReview: null,
                    reviewStage: 0,
                    todayAttempts: 0,
                    lastAttemptDate: today
                };
                reviewData.push(item);
            }

            // Êó•‰ªò„ÅåÂ§â„Çè„Å£„Åü„Çâ‰ªäÊó•„ÅÆÊåëÊà¶ÂõûÊï∞„Çí„É™„Çª„ÉÉ„Éà
            if (item.lastAttemptDate !== today) {
                item.todayAttempts = 0;
                item.lastAttemptDate = today;
            }

            item.todayAttempts++;
            item.lastReviewed = now.toISOString();

            if (isCorrect) {
                // Ê≠£Ëß£ÊôÇÔºöÂæ©Áøí„Çø„Ç§„Éü„É≥„Ç∞„Åß„ÅÇ„Çå„Å∞„Çπ„ÉÜ„Éº„Ç∏„ÇíÈÄ≤„ÇÅ„Çã
                const isReviewDue = !item.nextReview || (new Date(item.nextReview) <= now);

                if (isReviewDue) {
                    item.reviewStage++; // „Çπ„ÉÜ„Éº„Ç∏„Ç¢„ÉÉ„Éó
                }

                // Ê¨°Âõû„ÅÆ„Çπ„Ç±„Ç∏„É•„Éº„É´Ë®≠ÂÆö
                const intervals = [0, 1, 3, 7, 14]; // Êó•Êï∞

                // ÂÆöÁùÄÂÆå‰∫Ü„ÉÅ„Çß„ÉÉ„ÇØ
                if (item.reviewStage >= intervals.length) {
                    // ÂÆöÁùÄÂÆå‰∫ÜÔºöÂæ©Áøí„É™„Çπ„Éà„Åã„ÇâÂâäÈô§
                    const index = reviewData.indexOf(item);
                    reviewData.splice(index, 1);
                    saveReviewData(reviewData);
                    return;
                }

                // Ê¨°Âõû„ÅÆÂæ©Áøí‰∫àÂÆöÊó•„ÇíË®àÁÆó
                const nextDate = new Date(now);
                // „Åæ„Å†Âæ©ÁøíÊôÇÊúü„Åò„ÇÉ„Å™„ÅÑ„ÅÆ„Å´Á∑¥Áøí„Åó„ÅüÂ†¥Âêà„ÅØ„ÄÅÁèæÂú®ÊôÇÂàª„Åã„Çâ„Åß„ÅØ„Å™„Åè
                // „ÄåÊú¨Êù•„ÅÆ‰∫àÂÆöÊó•„Äç„Åæ„Åü„ÅØ„ÄåÁèæÂú®„Äç„ÅÆÈÅÖ„ÅÑÊñπ„Åã„ÇâË®àÁÆó„Åô„Åπ„Åç„Å†„Åå„ÄÅ
                // „Ç∑„É≥„Éó„É´„Å´„ÄåÊ≠£Ëß£„Åó„ÅüÊôÇÁÇπ„Åã„ÇâÊ¨°„ÅÆÈñìÈöî„Äç„ÅßË®≠ÂÆö„Åô„ÇãÂΩ¢„ÅßÂçÅÂàÜÔºàÂæ©Áøí„ÅÆÂâçÂÄí„Åó„ÅØ„Åó„Å™„ÅÑÔºâ
                nextDate.setDate(nextDate.getDate() + intervals[item.reviewStage]);
                item.nextReview = nextDate.toISOString();
            } else {
                // ‰∏çÊ≠£Ëß£ÊôÇÔºöÊ¨°„ÅÆÂæ©Áøí„Çø„Ç§„Éü„É≥„Ç∞„ÇíË®≠ÂÆö
                const nextReviewTime = new Date(now);

                if (item.todayAttempts === 1) {
                    // ÂàùÂõûÈñìÈÅï„ÅÑ ‚Üí 3ÊôÇÈñìÂæå
                    nextReviewTime.setHours(nextReviewTime.getHours() + 3);
                } else if (item.todayAttempts === 2) {
                    // 2ÂõûÁõÆÈñìÈÅï„ÅÑ ‚Üí ‰ªäÊó•„ÅÆÊúÄÁµÇ„Çª„ÉÉ„Ç∑„Éß„É≥Ôºà17ÊôÇÔºâ
                    nextReviewTime.setHours(17, 0, 0, 0);
                } else {
                    // 3ÂõûÁõÆ‰ª•Èôç ‚Üí ÁøåÊó•„ÅÆÊúù8ÊôÇ
                    nextReviewTime.setDate(nextReviewTime.getDate() + 1);
                    nextReviewTime.setHours(8, 0, 0, 0);
                }

                item.nextReview = nextReviewTime.toISOString();
                item.reviewStage = 0; // „Çπ„ÉÜ„Éº„Ç∏„Çí„É™„Çª„ÉÉ„Éà
            }

            saveReviewData(reviewData);
        }

        // Âæ©Áøí„Åô„Åπ„ÅçÂïèÈ°å„ÇíÂèñÂæó
        function getReviewQuestions() {
            const reviewData = loadReviewData();
            const now = new Date();

            return reviewData.filter(item => {
                if (!item.nextReview) return false;
                const nextReview = new Date(item.nextReview);
                return nextReview <= now;
            }).map(item => {
                const [left, right] = item.question.split('x').map(Number);
                return [left, right];
            });
        }

        // Ëã¶ÊâãÂàÜÊûêÔºàÁ∞°ÊòìÁâàÔºâ
        function analyzeWeakness() {
            const data = loadData();
            // ÊÆµ„Åî„Å®„ÅÆÊ≠£Ëß£Áéá„ÇíÈõÜË®à
            // 3„Äú9„ÅÆÊÆµ„ÅÆ„Åø
            const stats = {};
            for (let i = 3; i <= 9; i++) stats[i] = { total: 0, correct: 0 };

            data.history.forEach(item => {
                const [left, right] = item.q.split('x').map(Number);
                if (stats[left]) {
                    stats[left].total++;
                    if (item.correct) stats[left].correct++;
                }
            });

            return stats;
        }

        // --- ÁîªÈù¢ÈÅ∑Áßª ---
        function showScreen(id) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- „É¨„Éô„É´Ë™¨Êòé„ÉÄ„Ç§„Ç¢„É≠„Ç∞ ---
        function openLevelDialog() {
            document.getElementById('level-dialog').classList.add('active');
        }

        function closeLevelDialog() {
            document.getElementById('level-dialog').classList.remove('active');
        }

        // --- „Çπ„Çø„Éº„ÉàÁîªÈù¢„É≠„Ç∏„ÉÉ„ÇØ ---
        function openModeDialog(dan) {
            currentDan = dan;
            const title = (dan === 'all') ? "3„Äú9„ÅÆ„Å†„Çì" : `${dan}„ÅÆ„Å†„Çì`;
            document.getElementById('dialog-title').innerText = title;
            document.getElementById('mode-dialog').classList.add('active');
        }

        function closeModeDialog() {
            document.getElementById('mode-dialog').classList.remove('active');
        }

        // Âæ©Áøí„É¢„Éº„Éâ„ÅÆÈñãÂßã
        function startReviewMode() {
            const reviewQuestions = getReviewQuestions();
            if (reviewQuestions.length === 0) {
                alert('‰ªä„ÅØ„Åµ„Åè„Åó„ÇÖ„ÅÜ„Åô„Çã„ÇÇ„Çì„Å†„ÅÑ„Åå„Å™„ÅÑ„ÇàÔºÅ');
                return;
            }

            currentDan = 'review';
            currentMode = 'review';
            questionList = reviewQuestions;
            currentIndex = 0;
            results = [];
            showScreen('screen-game');
            showQuestion();
        }

        function startGame(mode) {
            currentMode = mode;
            closeModeDialog();
            generateQuestions();

            // „Éê„É©„Éê„É©„É¢„Éº„Éâ„Åã„Å§all„Åß„Å™„ÅÑÂ†¥Âêà„ÅØ10Âïè„Å´Âà∂Èôê„Åô„Çã„Åã„ÄÅ
            // „ÅÇ„Çã„ÅÑ„ÅØ„Äå‰∏ä„Çä„Äç‰ª•Â§ñ„ÇíÈÅ∏ÊäûËÇ¢„Å®„Åó„Å¶ÊåÅ„Å§Â†¥Âêà„ÅØÂÖ®Âïè„Åã„ÄÇ
            // ‰ªäÂõû„ÅÆ‰ªïÊßòÔºö
            // „Äå3„ÅÆÊÆµ„Äç-> junban(9Âïè) or barabara(9Âïè„Ç∑„É£„ÉÉ„Éï„É´)
            // „Äåall„Äç -> junban(63Âïè) or barabara(20Âïè„Éî„ÉÉ„ÇØ„Ç¢„ÉÉ„Éó)

            currentIndex = 0;
            results = [];
            showScreen('screen-game');
            showQuestion();
        }

        // ÂïèÈ°åÁîüÊàê
        function generateQuestions() {
            questionList = [];
            const dans = (currentDan === 'all') ? [3, 4, 5, 6, 7, 8, 9] : [currentDan];

            // ÂÖ®ÁµÑ„ÅøÂêà„Çè„Åõ„Çí‰ΩúÊàê
            let allPairs = [];
            dans.forEach(d => {
                for (let i = 1; i <= 9; i++) {
                    allPairs.push([d, i]);
                }
            });

            if (currentMode === 'junban') {
                // È†ÜÁï™ÈÄö„Çä
                questionList = allPairs;
            } else {
                // „Ç∑„É£„ÉÉ„Éï„É´
                for (let i = allPairs.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [allPairs[i], allPairs[j]] = [allPairs[j], allPairs[i]];
                }

                // ÂÖ®ÊÆµ„Éê„É©„Éê„É©„ÅÆ„Å®„Åç„ÅØÂïèÈ°åÊï∞„ÇíÁµû„Çã (20Âïè)
                if (currentDan === 'all') {
                    questionList = allPairs.slice(0, 20);
                } else {
                    // Âçò‰∏ÄÊÆµ„ÅÆ„Å®„Åç„ÅØ9Âïè„Åô„Åπ„Å¶ÂÆüÊñΩ
                    questionList = allPairs;
                }
            }
        }

        // --- „Ç≤„Éº„É†„É≠„Ç∏„ÉÉ„ÇØ ---
        function showQuestion() {
            const q = questionList[currentIndex];
            // 0.5ÁßíÈÅÖÂª∂„Åó„Å¶Ë°®Á§∫ÔºàÂâç„ÅÆ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„ÅåÊ∂à„Åà„Çã„ÅÆ„ÇíÂæÖ„Å§„Å™„Å©Ôºâ

            document.getElementById('q-left').innerText = q[0];
            document.getElementById('q-right').innerText = q[1];
            document.getElementById('answer-box').innerText = "";
            currentInput = "";
            wrongCountForCurrentQuestion = 0; // ÂõûÊï∞„É™„Çª„ÉÉ„Éà

            // ÈÄ≤Êçó„Éê„ÉºÊõ¥Êñ∞
            const pct = (currentIndex / questionList.length) * 100;
            document.getElementById('progress-fill').style.width = `${pct}%`;

            // ÈÄ£ÊâìÈò≤Ê≠¢Ëß£Èô§
            isProcessing = false;

            startTime = Date.now();

            // „Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ„É™„Çª„ÉÉ„Éà
            const fb = document.getElementById('feedback');
            fb.style.opacity = 0;
        }

        function inputNum(n) {
            // Á≠î„Åà„ÅØÊúÄÂ§ß81„Å™„ÅÆ„Åß2Ê°Å
            if (currentInput.length >= 2) return;
            currentInput += n;
            document.getElementById('answer-box').innerText = currentInput;
        }

        function clearInput() {
            currentInput = "";
            document.getElementById('answer-box').innerText = "";
        }

        function checkAnswer() {
            if (isProcessing) return; // Âá¶ÁêÜ‰∏≠„ÅØÁÑ°Ë¶ñ
            if (currentInput === "") return;

            const q = questionList[currentIndex];
            const userAns = parseInt(currentInput);
            const correctAns = q[0] * q[1];

            const isCorrect = (userAns === correctAns);

            if (isCorrect) {
                isProcessing = true; // Ê≠£Ëß£Âá¶ÁêÜÈñãÂßãÔºàÈÄ£ÊâìÈò≤Ê≠¢Ôºâ
            }

            // ÂàùÂõûÂõûÁ≠î„ÅÆ„ÅøÊ≠£Âê¶„ÇíË®òÈå≤„Åô„Çã„Åã„ÄÅÊØéÂõûË®òÈå≤„Åô„Çã„Åã„ÄÇ
            // „ÄåËã¶ÊâãÂàÜÊûê„Äç„ÅÆ„Åü„ÇÅ„Å´„ÅØ„ÄåÈñìÈÅï„Åà„Åü‰∫ãÂÆü„Äç„ÇíÊÆã„Åó„Åü„ÅÑ„ÄÇ
            // „Åì„Åì„Åß„ÅØ1Âïè„Å´„Å§„Åç1Âõû„É¨„Ç≥„Éº„Éâ„ÇíËøΩÂä†„Åô„Çã„ÅÆ„Åß„ÅØ„Å™„Åè„ÄÅ
            // „Äå„Åì„ÅÆÂïèÈ°å„ÇíÈñìÈÅï„Åà„Åü„Äç„Ç´„Ç¶„É≥„Éà„ÇíÂÜÖÈÉ®„ÅßË°å„ÅÑ„ÄÅÊúÄÂæå„Å´ÁµêÊûú„Å´„Åæ„Å®„ÇÅ„Çã„ÄÇ
            // „Åü„Å†„Åó„ÄÅtimestamp‰ªò„Åç„ÅÆÂ±•Ê≠¥(saveData)„ÅØÊØéÂõûË°å„ÅÜ„ÄÇ

            saveData({
                q: `${q[0]}x${q[1]}`,
                correct: isCorrect,
                time: Date.now() - startTime,
                date: Date.now()
            });

            // Âæ©Áøí„Çπ„Ç±„Ç∏„É•„Éº„É´„ÇíÊõ¥Êñ∞
            calculateNextReview(`${q[0]}x${q[1]}`, isCorrect);

            // Ë¶ñË¶öÁöÑ„Éï„Ç£„Éº„Éâ„Éê„ÉÉ„ÇØ
            const fb = document.getElementById('feedback');
            fb.innerText = isCorrect ? "‚óã" : "√ó";
            fb.className = `feedback ${isCorrect ? 'correct' : 'wrong'}`;

            // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥ÂÜçÁîü
            fb.style.animation = 'none';
            fb.offsetHeight; /* trigger reflow */
            fb.style.animation = 'feedbackAnim 0.6s ease-out';

            if (isCorrect) {
                // „Ç≥„É≥„ÉúÂä†ÁÆó
                comboCount++;
                const badge = document.getElementById('combo-badge');
                if (comboCount >= 3) {
                    badge.innerText = `${comboCount} „Ç≥„É≥„ÉúÔºÅ`;
                    badge.classList.add('active');
                }

                // ÁµêÊûú‰øùÂ≠ò („Åì„ÅÆÂïèÈ°å„Å´ÂØæ„Åó„Å¶)
                results.push({
                    q: q,
                    wrongCount: wrongCountForCurrentQuestion
                });

                setTimeout(nextQuestion, 700);
            } else {
                comboCount = 0;
                document.getElementById('combo-badge').classList.remove('active');
                wrongCountForCurrentQuestion++;
                // ‰∏çÊ≠£Ëß£„ÅÆÂ†¥Âêà„ÅØÂÖ•Âäõ„ÇØ„É™„Ç¢„Åó„Å¶ÂÜçÊåëÊà¶
                setTimeout(() => {
                    clearInput();
                }, 300);
            }
        }

        function nextQuestion() {
            currentIndex++;
            if (currentIndex >= questionList.length) {
                finishGame();
            } else {
                showQuestion();
            }
        }

        function finishGame() {
            showScreen('screen-result');

            // Ê∫ÄÁÇπ„Åã„Å©„ÅÜ„Åã
            // wrongCount > 0 „ÅÆÂïèÈ°å„Åå„ÅÇ„Å£„Åü„Åã„Å©„ÅÜ„Åã
            const mistakes = results.filter(r => r.wrongCount > 0);
            const isPerfect = (mistakes.length === 0);

            const stamp = document.getElementById('stamp');
            if (isPerfect) {
                stamp.innerText = "ÂêàÊ†º";
                stamp.style.borderColor = "#FF5252";
                stamp.style.color = "#FF5252";
                document.getElementById('score-text').innerHTML =
                    `<span style="color:#FF5252">„Åú„Çì„ÇÇ„Çì„Åõ„ÅÑ„Åã„ÅÑÔºÅ</span>`;
            } else {
                stamp.innerText = "ÂÆå‰∫Ü";
                stamp.style.borderColor = "#2196F3";
                stamp.style.color = "#2196F3";
                document.getElementById('score-text').innerText =
                    `${results.length}„ÇÇ„Çì‰∏≠ ${results.length - mistakes.length}„ÇÇ„Çì„Åõ„ÅÑ„Åã„ÅÑ`;
            }

            // ÈñìÈÅï„Åà„ÅüÂïèÈ°å„É™„Çπ„Éà
            const ul = document.getElementById('wrong-list');
            ul.innerHTML = "";
            if (mistakes.length === 0) {
                const li = document.createElement('li');
                li.innerText = "„Åæ„Å°„Åå„ÅÑ„ÅØ„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇ„Åô„Å∞„Çâ„Åó„ÅÑÔºÅ";
                li.style.justifyContent = "center";
                ul.appendChild(li);
            } else {
                mistakes.forEach(r => {
                    const li = document.createElement('li');
                    li.innerText = `${r.q[0]} √ó ${r.q[1]} = ${r.q[0] * r.q[1]} („Åæ„Å°„Åå„ÅÑ: ${r.wrongCount}„Åã„ÅÑ)`;
                    ul.appendChild(li);
                });
            }



            renderChart();

            // Ëá™ÂãïÈÄÅ‰ø°Âá¶ÁêÜ
            const savedNum = loadStudentNum();
            if (savedNum) {
                // Áï™Âè∑„Åå„ÅÇ„Çå„Å∞Ëá™Âãï„Åß„Ç≠„É•„Éº„Å´ËøΩÂä†
                createAndQueueExportData(savedNum);
            } else {
                // „Å™„Åë„Çå„Å∞„ÉÄ„Ç§„Ç¢„É≠„Ç∞Ë°®Á§∫
                openNumberDialog();
            }
        }

        function renderChart() {
            const stats = analyzeWeakness(); // {3: {total:10, correct:8}, ...}
            const container = document.getElementById('chart-container');
            container.innerHTML = "";

            // „Éá„Éº„Çø„Åå„ÅÇ„ÇãÊÆµ„Å†„ÅëË°®Á§∫„Åô„Çã„Åã„ÄÅ3-9ÂÖ®„Å¶Ë°®Á§∫„Åô„Çã„Åã -> ÂÖ®„Å¶Ë°®Á§∫
            for (let i = 3; i <= 9; i++) {
                const s = stats[i];
                let rate = 0;
                let hasData = s.total > 0;
                if (hasData) {
                    rate = Math.round((s.correct / s.total) * 100);
                }

                const group = document.createElement('div');
                group.className = 'bar-group';

                const bar = document.createElement('div');
                bar.className = 'bar';
                // „Éá„Éº„Çø„Åå„Å™„ÅÑÂ†¥Âêà„ÅØ0„Å†„Åå„ÄÅÂ∞ë„Åó„Å†„ÅëË°®Á§∫„Åó„Å¶„Åä„Åè(2px)
                const heightPct = hasData ? rate : 2;
                bar.style.height = `${heightPct}%`;

                // Ëâ≤ÂàÜ„Åë
                if (!hasData) {
                    bar.style.backgroundColor = '#e0e0e0';
                } else if (rate < 60) {
                    bar.style.backgroundColor = '#FF5252'; // Ëµ§
                } else if (rate < 90) {
                    bar.style.backgroundColor = '#FFC107'; // ÈªÑ
                } else {
                    bar.style.backgroundColor = '#2196F3'; // Èùí
                }

                const label = document.createElement('div');
                label.className = 'bar-label';
                label.innerText = i;

                group.appendChild(bar);
                group.appendChild(label);
                container.appendChild(group);
            }
        }

    </script>

    <script>
        // --- ÁøíÁÜüÂ∫¶Ë®àÁÆó ---
        function getMasteryLevel(dan, mode) {
            // mode: 'junban' or 'barabara'
            const data = loadData();
            const reviewData = loadReviewData();

            // „Åù„ÅÆÊÆµ„Éª„É¢„Éº„Éâ„Åß„ÅÆÁõ¥Ëøë„ÅÆÂÆåËµ∞„Éá„Éº„Çø„ÇíÊé¢„Åô
            // history„Åã„ÇâË©≤ÂΩì„Åô„ÇãÊÆµ„ÅÆÂïèÈ°å„ÇíÈõÜ„ÇÅ„Çã
            const danQuestions = [];
            for (let i = 1; i <= 9; i++) {
                danQuestions.push(`${dan}x${i}`);
            }

            // Áõ¥Ëøë„ÅÆÂ±•Ê≠¥„Åã„Çâ„Åì„ÅÆÊÆµ„ÅÆÊ≠£Ëß£Áéá„ÇíË®àÁÆó
            const recentHistory = data.history.filter(h => {
                const parts = h.q.split('x');
                return parseInt(parts[0]) === dan;
            });

            if (recentHistory.length === 0) return 'none'; // Êú™ÊåëÊà¶

            // Áõ¥Ëøë9ÂïèÂàÜÔºà1„Çª„ÉÉ„ÉàÂàÜÔºâ„ÅÆÁµêÊûú„ÇíÂèñÂæó
            const lastSet = recentHistory.slice(-9);
            const correctRate = lastSet.filter(h => h.correct).length / lastSet.length;

            if (correctRate < 0.7) return 'started'; // Ëµ§ÔºöÈñìÈÅï„ÅÑÂ§ö„ÅÑ

            // Âæ©Áøí„Éá„Éº„Çø„Åã„Çâ„Åì„ÅÆÊÆµ„ÅÆÂïèÈ°å„ÅÆ„Çπ„ÉÜ„Éº„Ç∏„ÇíÁ¢∫Ë™ç
            const danReviewItems = reviewData.filter(r => {
                const parts = r.question.split('x');
                return parseInt(parts[0]) === dan;
            });

            // Âæ©Áøí„É™„Çπ„Éà„Å´ÂïèÈ°å„ÅåÊÆã„Å£„Å¶„ÅÑ„ÇãÂ†¥Âêà
            if (danReviewItems.length > 0) {
                // ÊúÄ„ÇÇ‰Ωé„ÅÑ„Çπ„ÉÜ„Éº„Ç∏„ÅßÂà§ÂÆö
                const minStage = Math.min(...danReviewItems.map(r => r.reviewStage));
                if (minStage <= 1) return 'review';  // „Ç™„É¨„É≥„Ç∏ÔºöÁü≠ÊúüË®òÊÜ∂
                if (minStage <= 2) return 'growing';  // ÈªÑËâ≤Ôºö3Êó•Âæ©Áøí„ÇØ„É™„Ç¢
                return 'almost'; // ÈªÑÁ∑ëÔºö7Êó•‰ª•‰∏ä
            }

            // Âæ©Áøí„É™„Çπ„Éà„Å´ÂïèÈ°å„Åå„Å™„ÅÑ = ÂÖ®ÂïèÂÆöÁùÄÊ∏à„Åø„Åæ„Åü„ÅØÊ≠£Ëß£ÁéáÈ´ò„ÅÑ
            if (correctRate >= 0.9) return 'complete'; // ÈùíÔºöÂÆåÂÖ®ÂÆöÁùÄ
            return 'almost'; // ÈªÑÁ∑ë
        }

        function updateMasteryColors() {
            for (let dan = 3; dan <= 9; dan++) {
                const jLevel = getMasteryLevel(dan, 'junban');
                const bLevel = getMasteryLevel(dan, 'barabara');

                const jEl = document.getElementById(`m-${dan}-j`);
                const bEl = document.getElementById(`m-${dan}-b`);

                if (jEl) {
                    jEl.className = `mastery-half left mastery-${jLevel}`;
                }
                if (bEl) {
                    bEl.className = `mastery-half mastery-${bLevel}`;
                }
            }
        }

        // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ„ÅÆÂàùÊúüÂåñ
        window.addEventListener('DOMContentLoaded', function () {
            const session = getCurrentSession();
            const sessionName = getSessionName(session);
            const reviewQuestions = getReviewQuestions();
            const reviewCount = reviewQuestions.length;

            // „Çª„ÉÉ„Ç∑„Éß„É≥„Å´Âøú„Åò„Åü„Çµ„Éñ„Çø„Ç§„Éà„É´
            if (session !== 'free') {
                document.getElementById('session-subtitle').innerText = sessionName + ' „ÅÆ„Åò„Åã„Çì„Å†„ÇàÔºÅ';
            }

            // Âæ©Áøí„Åô„Åπ„ÅçÂïèÈ°å„Åå„ÅÇ„Çå„Å∞„Äå„Åä„Åô„Åô„ÇÅ„Äç„Éú„Çø„É≥„ÇíË°®Á§∫
            if (reviewCount > 0) {
                document.getElementById('recommend-section').style.display = 'block';
                document.getElementById('recommend-text').innerText = sessionName;
                document.getElementById('recommend-count').innerText = `„Åµ„Åè„Åó„ÇÖ„ÅÜ ${reviewCount}„ÇÇ„Çì`;
            }

            // ÁøíÁÜüÂ∫¶„Ç´„É©„Éº„ÇíÊõ¥Êñ∞
            updateMasteryColors();
        });

        // --- „Çè„Åã„Çâ„Å™„ÅÑ„Éú„Çø„É≥ ---
        function skipQuestion() {
            if (isProcessing) return;
            isProcessing = true;

            const q = questionList[currentIndex];
            const correctAns = q[0] * q[1];

            // Á≠î„Åà„ÇíË°®Á§∫
            document.getElementById('answer-box').innerText = correctAns;
            document.getElementById('answer-box').style.color = '#2196F3';

            // ‰∏çÊ≠£Ëß£„Å®„Åó„Å¶Ë®òÈå≤
            saveData({
                q: `${q[0]}x${q[1]}`,
                correct: false,
                time: Date.now() - startTime,
                date: Date.now()
            });
            calculateNextReview(`${q[0]}x${q[1]}`, false);

            // „Ç≥„É≥„Éú„É™„Çª„ÉÉ„Éà
            comboCount = 0;
            document.getElementById('combo-badge').classList.remove('active');

            // ÁµêÊûú„Å´Ë®òÈå≤
            results.push({
                q: q,
                wrongCount: wrongCountForCurrentQuestion + 1
            });

            // ÂïèÈ°å„É™„Çπ„Éà„ÅÆÊú´Â∞æ„Å´Âêå„ÅòÂïèÈ°å„ÇíËøΩÂä†Ôºà„ÅÇ„Å®„Åß„ÇÇ„ÅÜ‰∏ÄÂ∫¶Âá∫È°åÔºâ
            questionList.push([q[0], q[1]]);

            // 2ÁßíÈñìÁ≠î„Åà„ÇíË¶ã„Åõ„Å¶„Åã„ÇâÊ¨°„ÅÆÂïèÈ°å„Å∏
            setTimeout(() => {
                document.getElementById('answer-box').style.color = 'var(--primary-color)';
                nextQuestion();
            }, 2000);
        }

        // --- HOMEÁ¢∫Ë™ç„Éù„ÉÉ„Éó„Ç¢„ÉÉ„Éó ---
        function confirmHome() {
            if (confirm('„Åª„Çì„Å®„ÅÜ„Å´ „Åä„Çè„Çä„Åæ„Åô„ÅãÔºü')) {
                location.reload();
            }
        }

        // --- ÁîüÂæíÁï™Âè∑ÂÖ•Âäõ„Å®ÈÄÅ‰ø° ---
        let studentNumber = "";

        function openNumberDialog() {
            // ‰øùÂ≠ò„Åï„Çå„ÅüÁï™Âè∑„Åå„ÅÇ„Çå„Å∞„Åù„Çå„Çí„Çª„ÉÉ„Éà
            const saved = loadStudentNum();
            if (saved) {
                studentNumber = saved;
            } else {
                studentNumber = "";
            }
            document.getElementById('number-display').innerText = studentNumber;
            document.getElementById('number-dialog').classList.add('active');
        }

        function closeNumberDialog() {
            document.getElementById('number-dialog').classList.remove('active');
        }

        function inputStudentNum(n) {
            if (studentNumber.length >= 3) return;
            studentNumber += n;
            document.getElementById('number-display').innerText = studentNumber;
        }

        function clearStudentNum() {
            studentNumber = '';
            document.getElementById('number-display').innerText = '';
        }

        function submitStudentNum() {
            if (studentNumber === '') {
                alert('„Å∞„Çì„Åî„ÅÜ„Çí„ÅÑ„Çå„Å¶„Å≠');
                return;
            }
            saveStudentNum(studentNumber); // Áï™Âè∑„Çí‰øùÂ≠ò
            closeNumberDialog();

            // „Éá„Éº„Çø‰ΩúÊàê„Å®„Ç≠„É•„ÉºËøΩÂä†
            createAndQueueExportData(studentNumber);
            alert('„Éá„Éº„Çø„Çí„Åª„Åû„Çì„Åó„Åæ„Åó„Åü„ÄÇ„Åò„Å©„ÅÜ„Åß„Åù„ÅÜ„Åó„Çì„Åó„Åæ„ÅôÔºÅ');
        }

        // ÈÄÅ‰ø°„Éá„Éº„Çø„ÅÆ‰ΩúÊàê„Å®„Ç≠„É•„Éº„Ç§„É≥„Ç∞
        function createAndQueueExportData(studentNum) {
            const now = new Date();
            const data = loadData();
            const reviewData = loadReviewData();

            const exportObj = {
                id: Date.now().toString() + Math.random().toString(36).substr(2, 5), // Unique ID
                exportDate: now.toISOString(),
                studentName: studentNum,
                totalQuestions: data.history.length,
                correctCount: data.history.filter(h => h.correct).length,
                wrongCount: data.history.filter(h => h.correct === false).length,
                reviewQueueCount: reviewData.length,
                weaknessAnalysis: analyzeWeakness()
            };

            addToQueue(exportObj);
        }

        // „Ç≠„É•„Éº„ÅÆÂá¶ÁêÜÔºàÈÄÅ‰ø°„É™„Éà„É©„Ç§Ôºâ
        let isSending = false;
        async function processQueue() {
            if (isSending) return;

            const queue = loadQueue();
            if (queue.length === 0) return;

            isSending = true;
            const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyfKDqXB7-qX5HPWutvaGCe5cWi31LZbTQYT2omiGdDIKP27ZzMbmqiqTejQdhoPfxX/exec';

            // ÂÖàÈ†≠„Åã„ÇâÈ†Ü„Å´ÈÄÅ‰ø°
            // ‚ÄªÈÄÅ‰ø°ÊàêÂäü„Åó„Åü„ÇÇ„ÅÆ„Å†„ÅëÂâäÈô§„Åô„Çã
            const newQueue = [...queue];
            let sentCount = 0;

            for (const item of queue) {
                try {
                    await fetch(GOOGLE_SCRIPT_URL, {
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(item)
                    });

                    // no-cors„Å™„ÅÆ„ÅßÊàêÂäü„ÅãÂé≥ÂØÜ„Å´„ÅØ„Çè„Åã„Çâ„Å™„ÅÑ„Åå„ÄÅ„Ç®„É©„Éº„ÅåÂá∫„Å™„Åë„Çå„Å∞ÊàêÂäü„Å®„Åø„Å™„Åô
                    // ÔºàGASÂÅ¥„ÅßÂèó‰ø°„É≠„Ç∞„ÇíÊÆã„ÅôÂâçÊèêÔºâ
                    console.log('Sent item:', item.id);

                    // ÈÄÅ‰ø°Ê∏à„Åø„Ç¢„Ç§„ÉÜ„É†„ÇíÂâäÈô§
                    const idx = newQueue.findIndex(q => q.id === item.id);
                    if (idx !== -1) newQueue.splice(idx, 1);

                    sentCount++;

                } catch (error) {
                    console.error('Send error:', error);
                    // „Ç®„É©„Éº„Å™„Çâ„É´„Éº„Éó„ÇíÊäú„Åë„Å¶„ÄÅÊÆã„Çä„ÅØÊ¨°Âõû„Å∏
                    break;
                }
            }

            saveQueue(newQueue);
            isSending = false;

            if (sentCount > 0 && newQueue.length === 0) {
                // ÂÖ®„Å¶ÈÄÅ‰ø°ÂÆå‰∫Ü
                console.log('All queue items sent.');
            }
        }

        // ÂÆöÊúüÁöÑ„Å´ÈÄÅ‰ø°Ë©¶Ë°åÔºà2ÂàÜ„Åî„Å®Ôºâ
        setInterval(processQueue, 120000);

        // Ëµ∑ÂãïÊôÇ„Å´„ÇÇË©¶Ë°å
        window.addEventListener('load', () => {
            // Â∞ë„ÅóÂæÖ„Å£„Å¶„Åã„ÇâÂÆüË°å
            setTimeout(processQueue, 3000);
        });


        let myChart = null;
        function showProgressScreen() {
            showScreen('screen-progress');

            // „Éá„Éº„ÇøÈõÜË®à
            const labels = [];
            const dataPoints = [];
            const backgroundColors = [];

            const listContainer = document.getElementById('progress-list');
            listContainer.innerHTML = "";

            for (let d = 2; d <= 9; d++) { // 2„ÅÆÊÆµ„Åã„Çâ9„ÅÆÊÆµ
                const prog = getDanProgress(d);
                labels.push(d + '„ÅÆ„Å†„Çì');
                dataPoints.push(prog.levelScore);
                backgroundColors.push(prog.color);

                // „É™„Çπ„ÉàË°®Á§∫
                const div = document.createElement('div');
                div.className = 'progress-item';
                div.innerHTML = `
                    <div>
                        <span class="progress-dan">${d}„ÅÆ„Å†„Çì</span>
                        <span class="progress-badge" style="background:${prog.color}">${prog.levelLabel}</span>
                    </div>
                    <div style="text-align:right;">
                        <div class="progress-status" style="color:#2196F3; font-weight:bold;">${prog.subMessage}</div>
                        <div class="progress-status" style="font-size:0.8em;">${prog.message}</div>
                    </div>
                `;
                listContainer.appendChild(div);
            }

            // „ÉÅ„É£„Éº„ÉàÊèèÁîª
            const ctx = document.getElementById('masteryChart').getContext('2d');

            if (myChart) {
                myChart.destroy();
            }

            myChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '„É¨„Éô„É´',
                        data: dataPoints,
                        backgroundColor: backgroundColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 5,
                            ticks: {
                                stepSize: 1,
                                callback: function (value) {
                                    const labels = ["„Åæ„Å†", "ÈñãÂßã", "ÂàùÊúü", "‰∏≠Êúü", "ÂæåÊúü", "ÂÆå‰∫Ü"];
                                    return labels[value] || value;
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }
    </script>
</body>

</html>